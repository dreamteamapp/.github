name: Monday Item Connection Check

on:
  workflow_call:

jobs:
  check-monday-connection:
    name: Verify Monday Item Connection
    runs-on: ubuntu-latest

    steps:
      - name: Check PR Description for Monday Link
        id: check-description
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR description for Monday link..."
          
          # Check if PR body contains a Monday.com URL with pulses (item ID)
          if echo "$PR_BODY" | grep -qiE 'monday\.com.*/pulses/[0-9]+'; then
            # Extract the Monday URL from the PR body
            MONDAY_URL=$(echo "$PR_BODY" | grep -oiE 'https?://[^[:space:]]*monday\.com[^[:space:]]*pulses/[0-9]+[^[:space:]]*' | head -1)
            # Extract the Monday item ID from the pulses URL
            MONDAY_ITEM_ID=$(echo "$MONDAY_URL" | grep -oE 'pulses/[0-9]+' | grep -oE '[0-9]+')
            echo "monday_url=$MONDAY_URL" >> $GITHUB_OUTPUT
            echo "monday_item_id=$MONDAY_ITEM_ID" >> $GITHUB_OUTPUT
            echo "description_valid=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR description contains Monday link: $MONDAY_URL"
            echo "‚úÖ Extracted Monday Item ID: $MONDAY_ITEM_ID"
          else
            echo "description_valid=false" >> $GITHUB_OUTPUT
            echo "‚ùå PR description does not contain a Monday.com link with item ID"
            echo ""
            echo "Please add the Monday ticket link to your PR description."
            echo "Example: https://yourcompany.monday.com/boards/123456789/pulses/1234567890"
          fi

      - name: Check Branch Name for Monday Item ID
        id: check-branch
        env:
          BRANCH_NAME: ${{ github.head_ref }}
          MONDAY_ITEM_ID: ${{ steps.check-description.outputs.monday_item_id }}
        run: |
          echo "Branch name: $BRANCH_NAME"
          
          # If we have a Monday item ID from the PR description, check if it's in the branch
          if [ -n "$MONDAY_ITEM_ID" ]; then
            if echo "$BRANCH_NAME" | grep -qE "$MONDAY_ITEM_ID"; then
              echo "branch_valid=true" >> $GITHUB_OUTPUT
              echo "consistency_valid=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Branch name contains Monday Item ID: $MONDAY_ITEM_ID"
            else
              echo "branch_valid=false" >> $GITHUB_OUTPUT
              echo "consistency_valid=false" >> $GITHUB_OUTPUT
              echo "‚ùå Branch name does not contain the Monday Item ID from PR description: $MONDAY_ITEM_ID"
              echo ""
              echo "Expected branch name format:"
              echo "  feature/<monday-item-id>-<description>  OR  feature/<description>-<monday-item-id>"
              echo "Examples:"
              echo "  feature/$MONDAY_ITEM_ID-add-user-authentication"
              echo "  feature/add-user-authentication-$MONDAY_ITEM_ID"
            fi
          else
            # No Monday item ID from PR, fall back to checking for any 8+ digit number
            if echo "$BRANCH_NAME" | grep -qE '[0-9]{8,}'; then
              FOUND_ID=$(echo "$BRANCH_NAME" | grep -oE '[0-9]{8,}' | head -1)
              echo "branch_valid=true" >> $GITHUB_OUTPUT
              echo "consistency_valid=false" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Branch name contains a number ($FOUND_ID), but PR description is missing Monday link to verify"
            else
              echo "branch_valid=false" >> $GITHUB_OUTPUT
              echo "consistency_valid=false" >> $GITHUB_OUTPUT
              echo "‚ùå Branch name does not contain a Monday Item ID (8+ digits)"
              echo ""
              echo "Expected branch name format:"
              echo "  feature/<monday-item-id>-<description>  OR  feature/<description>-<monday-item-id>"
              echo "Examples:"
              echo "  feature/1234567890-add-user-authentication"
              echo "  feature/add-user-authentication-1234567890"
            fi
          fi

      - name: Generate Summary
        run: |
          echo "## Monday Item Connection Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-branch.outputs.branch_valid }}" == "true" ]; then
            echo "‚úÖ **Branch Name**: Contains Monday Item ID \`${{ steps.check-description.outputs.monday_item_id }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Branch Name**: Missing Monday Item ID" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-description.outputs.description_valid }}" == "true" ]; then
            echo "‚úÖ **PR Description**: Contains Monday.com link" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **PR Description**: Missing Monday.com link" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-branch.outputs.branch_valid }}" == "true" ] && [ "${{ steps.check-description.outputs.description_valid }}" == "true" ]; then
            if [ "${{ steps.check-branch.outputs.consistency_valid }}" == "true" ]; then
              echo "‚úÖ **ID Consistency**: Branch Monday Item ID matches PR description" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå **ID Consistency**: Branch Monday Item ID does not appear in PR description" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SOC2 Compliance Requirement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "For SOC2 Type 2 compliance, all PRs must have a two-way connection to Monday tickets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Branch name must contain the Monday Item ID (8+ digits)" >> $GITHUB_STEP_SUMMARY
          echo "2. PR description must contain the Monday ticket URL" >> $GITHUB_STEP_SUMMARY
          echo "3. The Monday Item ID in the branch must match the ticket in the PR description" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch naming formats**:" >> $GITHUB_STEP_SUMMARY
          echo "- \`feature/<monday-item-id>-<description>\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`feature/<description>-<monday-item-id>\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Examples**:" >> $GITHUB_STEP_SUMMARY
          echo "- \`feature/1234567890-add-user-authentication\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`feature/add-user-authentication-1234567890\`" >> $GITHUB_STEP_SUMMARY

      - name: Fail if Requirements Not Met
        if: steps.check-branch.outputs.branch_valid != 'true' || steps.check-description.outputs.description_valid != 'true' || steps.check-branch.outputs.consistency_valid != 'true'
        run: |
          echo ""
          echo "=========================================="
          echo "‚ùå SOC2 COMPLIANCE CHECK FAILED"
          echo "=========================================="
          echo ""
          
          if [ "${{ steps.check-branch.outputs.branch_valid }}" != "true" ]; then
            echo "ISSUE: Branch name does not contain a Monday Item ID"
            echo ""
            echo "To fix this, create a new branch with the correct naming:"
            echo "  git checkout -b feature/<monday-item-id>-<description>"
            echo "  OR"
            echo "  git checkout -b feature/<description>-<monday-item-id>"
            echo ""
            echo "Then push and create a new PR from that branch."
            echo ""
          fi
          
          if [ "${{ steps.check-description.outputs.description_valid }}" != "true" ]; then
            echo "ISSUE: PR description does not contain a Monday.com link"
            echo ""
            echo "To fix this, edit your PR description and add the Monday ticket link:"
            echo "  üîó Monday Ticket: https://yourcompany.monday.com/boards/xxxxx/pulses/<item-id>"
            echo ""
          fi
          
          if [ "${{ steps.check-branch.outputs.branch_valid }}" == "true" ] && [ "${{ steps.check-description.outputs.description_valid }}" == "true" ] && [ "${{ steps.check-branch.outputs.consistency_valid }}" != "true" ]; then
            echo "ISSUE: Monday Item ID mismatch between branch and PR description"
            echo ""
            echo "The Monday Item ID from PR description (${{ steps.check-description.outputs.monday_item_id }}) does not"
            echo "appear in your branch name. This breaks the two-way connection requirement."
            echo ""
            echo "To fix this, ensure your PR description contains a link to the same Monday ticket"
            echo "referenced in your branch name."
            echo ""
          fi
          
          echo "=========================================="
          echo "For SOC2 compliance, all conditions must be met."
          echo "=========================================="
          
          exit 1

